import{r as n,j as e,H as $,a as h}from"./app-DLu82VbL.js";import{R as G}from"./RepresentativeLayout-Dd1lkglj.js";import{G as T,V as A,C as E,u as _,M as L}from"./index-UdTL3sIO.js";/* empty css            */const X=({cart:i=[],customers:b,representatives:P})=>{const[K,O]=n.useState("customer"),[u,w]=n.useState(null),[R,H]=n.useState(""),[I,M]=n.useState(""),[x,F]=n.useState(0),[j,S]=n.useState(""),[m,C]=n.useState(""),[y,g]=n.useState(!1),[r,f]=n.useState({}),s=(()=>{const t=i.reduce((c,l)=>{const d=l.quantity*l.unit_sale_price;return c+d},0),a=t,o=a-x,v=i.reduce((c,l)=>{const d=parseFloat(l.product?.piece_weight_grams)||0,k=parseFloat(l.product?.pieces_per_carton)||1,D=(parseFloat(l.quantity)||0)*k*d;return c+D},0);return{subtotal:t,total:a,remaining:o,totalWeightGrams:v,totalWeightKg:v/1e3,profit:i.reduce((c,l)=>{const d=(l.unit_sale_price-(l.product.purchase_price||0))*l.quantity;return c+d},0)}})(),p=()=>s.remaining<=0?"paid":x>0?"partial":"debt",q=()=>{const t={};return i.length===0&&(t.cart="لا توجد منتجات في السلة"),u||(t.customer="يجب اختيار عميل"),s.remaining>0&&!m&&(t.dueDate="يجب تحديد تاريخ الاستحقاق للديون"),f(t),Object.keys(t).length===0},W=async()=>{if(q()){g(!0);try{const t={sale_type:"customer",customer_name:null,customer_phone:null,customer_id:u?.id,representative_id:null,subtotal:s.subtotal,discount_amount:0,total_amount:s.total,paid_amount:x,remaining_amount:s.remaining,payment_status:p(),due_date:s.remaining>0?m:null,notes:j,items:i.map(a=>({product_id:a.product.id,quantity:a.quantity,unit_sale_price:a.unit_sale_price,unit_discount:0,total_price:a.unit_sale_price*a.quantity}))};h.post("/representatives/pos",t,{onSuccess:a=>{const o=s.totalWeightGrams>0?`
الوزن الكلي: ${s.totalWeightGrams.toLocaleString()} غرام${s.totalWeightKg>=1?` (${s.totalWeightKg.toFixed(2)} كغ)`:""}`:"";alert(`تم إنجاز البيع بنجاح! الفاتورة الآن في حالة الانتظار${o}`),h.visit("/representatives/pos")},onError:a=>{console.error("خطأ في البيع:",a),f(a||{general:"فشل في إنجاز البيع"})},onFinish:()=>{g(!1)}})}catch(t){console.error("خطأ في الشبكة:",t),alert("خطأ في الاتصال بالخادم"),g(!1)}}},N=()=>{h.visit("/representatives/pos")};return e.jsxs(G,{title:"فاتورة البيع",children:[e.jsx($,{title:"فاتورة البيع"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:N,className:"flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors text-gray-700",children:[e.jsx(T,{className:"w-4 h-4"}),"العودة"]}),e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"فاتورة البيع"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(A,{className:"w-5 h-5"}),e.jsxs("span",{className:"text-sm font-medium",children:[i.length," منتج"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200",children:[e.jsx("div",{className:"p-3 border-b border-gray-200",children:e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"تفاصيل الفاتورة"})}),e.jsxs("div",{className:"p-3",children:[e.jsxs("div",{className:"space-y-2 mb-3",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm",children:"المنتجات:"}),i.map(t=>e.jsxs("div",{className:"flex justify-between items-center p-2 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm",children:t.product.name}),e.jsxs("div",{className:"text-xs text-gray-600",children:[t.quantity," × ",t.unit_sale_price," د.ع"]}),e.jsxs("div",{className:"text-xs text-green-600 mt-1",children:[parseFloat(t.product?.pieces_per_carton)>0&&e.jsxs("span",{className:"mr-2",children:["🧩 ",t.product.pieces_per_carton," قطعة/كارتون"]}),parseFloat(t.product?.piece_weight_grams)>0&&e.jsxs("span",{children:["⚖️ ",t.product.piece_weight_grams," غ/قطعة"]})]}),parseFloat(t.product?.piece_weight_grams)>0&&e.jsxs("div",{className:"text-xs text-purple-600",children:["الوزن الكلي: ",(parseFloat(t.quantity)*(parseFloat(t.product.pieces_per_carton)||1)*parseFloat(t.product.piece_weight_grams)).toLocaleString()," غرام",parseFloat(t.quantity)*(parseFloat(t.product.pieces_per_carton)||1)*parseFloat(t.product.piece_weight_grams)>=1e3&&e.jsxs("span",{className:"ml-1",children:["(",(parseFloat(t.quantity)*(parseFloat(t.product.pieces_per_carton)||1)*parseFloat(t.product.piece_weight_grams)/1e3).toFixed(2)," كغ)"]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["(",t.quantity," كارتون × ",t.product.pieces_per_carton||1," قطعة × ",t.product.piece_weight_grams," غ)"]})]})]}),e.jsxs("div",{className:"font-semibold text-gray-900 text-sm",children:[(t.unit_sale_price*t.quantity).toFixed(2)," د.ع"]})]},t.id))]}),e.jsxs("div",{className:"mb-3 p-3 bg-purple-50 rounded-lg border border-purple-200",children:[e.jsx("h4",{className:"font-semibold text-purple-900 text-sm mb-2 flex items-center gap-2",children:"⚖️ الوزن الكلي للفاتورة"}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-700",children:[s.totalWeightGrams>0?s.totalWeightGrams.toLocaleString():"0"," غرام"]}),s.totalWeightKg>=1&&e.jsxs("div",{className:"text-lg text-purple-600 mt-1",children:["(",s.totalWeightKg.toFixed(2)," كيلو غرام)"]}),s.totalWeightGrams===0&&e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:"(لا توجد بيانات وزن للمنتجات)"})]})]}),e.jsxs("div",{className:"space-y-1 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"المجموع الفرعي:"}),e.jsxs("span",{className:"font-semibold",children:[s.subtotal.toFixed(2)," د.ع"]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsx("span",{children:"الربح المتوقع:"}),e.jsxs("span",{className:"font-semibold",children:[s.profit.toFixed(2)," د.ع"]})]}),e.jsxs("div",{className:"flex justify-between text-base font-bold border-t pt-1 mt-1",children:[e.jsx("span",{children:"الإجمالي:"}),e.jsxs("span",{className:"text-blue-600",children:[s.total.toFixed(2)," د.ع"]})]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200",children:[e.jsx("div",{className:"p-3 border-b border-gray-200",children:e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"معلومات العميل والدفع"})}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"العميل"}),e.jsxs("select",{value:u?.id||"",onChange:t=>{const a=b.find(o=>o.id==t.target.value);w(a)},className:`w-full px-2 py-1.5 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 ${r.customer?"border-red-500":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"اختر عميل"}),b.map(t=>e.jsxs("option",{value:t.id,children:[t.name," ",t.phone&&`- ${t.phone}`]},t.id))]}),r.customer&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:r.customer})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"المبلغ المدفوع"}),e.jsx("input",{type:"number",step:"0.01",value:x,onChange:t=>F(parseFloat(t.target.value)||0),className:`w-full px-2 py-1.5 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 ${r.paidAmount?"border-red-500":"border-gray-300"}`,placeholder:"0.00"}),r.paidAmount&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:r.paidAmount})]}),e.jsxs("div",{className:`flex justify-between text-sm p-2 rounded-lg ${s.remaining>0?"bg-red-50 text-red-700":"bg-green-50 text-green-700"}`,children:[e.jsx("span",{children:"المتبقي:"}),e.jsxs("span",{className:"font-semibold",children:[s.remaining.toFixed(2)," د.ع"]})]}),s.remaining>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"تاريخ الاستحقاق"}),e.jsx("input",{type:"date",value:m,onChange:t=>C(t.target.value),min:new Date().toISOString().split("T")[0],className:`w-full px-2 py-1.5 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 ${r.dueDate?"border-red-500":"border-gray-300"}`}),r.dueDate&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:r.dueDate})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"ملاحظات"}),e.jsx("textarea",{value:j,onChange:t=>S(t.target.value),rows:2,className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",placeholder:"ملاحظات إضافية..."})]}),e.jsxs("div",{className:"flex items-center gap-2 p-2 rounded-lg bg-gray-50",children:[p()==="paid"&&e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{className:"text-sm text-green-700 font-medium",children:"دفع كامل"})]}),p()==="partial"&&e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4 text-yellow-500"}),e.jsx("span",{className:"text-sm text-yellow-700 font-medium",children:"دفع جزئي"})]}),p()==="debt"&&e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:"text-sm text-red-700 font-medium",children:"دين كامل"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-3",children:[e.jsxs("button",{onClick:W,disabled:y||i.length===0,className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors text-sm",children:[y?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(L,{className:"w-4 h-4"}),"إنجاز البيع"]}),e.jsx("button",{onClick:N,className:"px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm",children:"إلغاء"})]}),Object.keys(r).length>0&&e.jsx("div",{className:"p-2 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("div",{className:"text-red-700 text-xs",children:Object.values(r).map((t,a)=>e.jsxs("div",{children:["• ",t]},a))})})]})]})]})]})]})};export{X as default};
