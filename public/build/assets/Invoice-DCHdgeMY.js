import{r as n,j as e,H as A,a as b}from"./app-nFOrUbza.js";import{R as E}from"./RepresentativeLayout-7ylgactW.js";import{G as O,L as P,C as $,u as _,P as L}from"./index-CQIIe2w9.js";/* empty css            */const W=({cart:i=[],discountAmount:w=0,customers:j,representatives:R})=>{const[H,I]=n.useState("customer"),[m,S]=n.useState(null),[B,G]=n.useState(""),[z,J]=n.useState(""),[x,F]=n.useState(0),[o,C]=n.useState(w),[f,k]=n.useState(""),[p,D]=n.useState(""),[y,g]=n.useState(!1),[r,N]=n.useState({}),a=(()=>{const s=i.reduce((c,l)=>{const h=l.quantity*l.unit_sale_price-l.quantity*l.unit_discount;return c+h},0),t=s-o,d=t-x;return{subtotal:s,total:t,remaining:d,profit:i.reduce((c,l)=>{const h=(l.unit_sale_price-l.unit_discount-l.product.cost_price)*l.quantity;return c+h},0)}})(),u=()=>a.remaining<=0?"paid":x>0?"partial":"debt",q=()=>{const s={};return i.length===0&&(s.cart="لا توجد منتجات في السلة"),m||(s.customer="يجب اختيار عميل"),a.remaining>0&&!p&&(s.dueDate="يجب تحديد تاريخ الاستحقاق للديون"),N(s),Object.keys(s).length===0},T=async()=>{if(q()){g(!0);try{const s={sale_type:"customer",customer_name:null,customer_phone:null,customer_id:m?.id,representative_id:null,subtotal:a.subtotal,discount_amount:o,total_amount:a.total,paid_amount:x,remaining_amount:a.remaining,payment_status:u(),due_date:a.remaining>0?p:null,notes:f,items:i.map(t=>({product_id:t.product.id,quantity:t.quantity,unit_sale_price:t.unit_sale_price,unit_discount:t.unit_discount,total_price:(t.unit_sale_price-t.unit_discount)*t.quantity}))};b.post("/representatives/pos",s,{onSuccess:t=>{alert("تم إنجاز البيع بنجاح! الفاتورة الآن في حالة الانتظار"),b.visit("/representatives/pos")},onError:t=>{console.error("خطأ في البيع:",t),N(t||{general:"فشل في إنجاز البيع"})},onFinish:()=>{g(!1)}})}catch(s){console.error("خطأ في الشبكة:",s),alert("خطأ في الاتصال بالخادم"),g(!1)}}},v=()=>{b.visit("/representatives/pos")};return e.jsxs(E,{title:"فاتورة البيع",children:[e.jsx(A,{title:"فاتورة البيع"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:v,className:"flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors text-gray-700",children:[e.jsx(O,{className:"w-4 h-4"}),"العودة"]}),e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"فاتورة البيع"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx(P,{className:"w-5 h-5"}),e.jsxs("span",{className:"text-sm font-medium",children:[i.length," منتج"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200",children:[e.jsx("div",{className:"p-3 border-b border-gray-200",children:e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"تفاصيل الفاتورة"})}),e.jsxs("div",{className:"p-3",children:[e.jsxs("div",{className:"space-y-2 mb-3",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm",children:"المنتجات:"}),i.map(s=>e.jsxs("div",{className:"flex justify-between items-center p-2 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm",children:s.product.name}),e.jsxs("div",{className:"text-xs text-gray-600",children:[s.quantity," × ",s.unit_sale_price," د.ع",s.unit_discount>0&&` (خصم: ${s.unit_discount} د.ع)`]}),s.product.supplier_name&&e.jsxs("div",{className:"text-xs text-blue-600",children:["المورد: ",s.product.supplier_name]})]}),e.jsxs("div",{className:"font-semibold text-gray-900 text-sm",children:[((s.unit_sale_price-s.unit_discount)*s.quantity).toFixed(2)," د.ع"]})]},s.id))]}),(()=>{const s={};return i.forEach(t=>{const d=t.product.supplier_name||"مورد غير محدد",c=(t.unit_sale_price-t.unit_discount)*t.quantity;s[d]=(s[d]||0)+c}),Object.keys(s).length>1&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm mb-2",children:"توزيع المبالغ حسب المورد:"}),e.jsx("div",{className:"space-y-1",children:Object.entries(s).map(([t,d])=>e.jsxs("div",{className:"flex justify-between text-xs p-1.5 bg-blue-50 rounded",children:[e.jsx("span",{className:"text-blue-700",children:t}),e.jsxs("span",{className:"text-blue-900 font-medium",children:[d.toFixed(2)," د.ع"]})]},t))})]})})(),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"خصم إضافي على الفاتورة"}),e.jsx("input",{type:"number",step:"0.01",value:o,onChange:s=>C(parseFloat(s.target.value)||0),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",placeholder:"0.00"})]}),e.jsxs("div",{className:"space-y-1 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"المجموع الفرعي:"}),e.jsxs("span",{className:"font-semibold",children:[a.subtotal.toFixed(2)," د.ع"]})]}),o>0&&e.jsxs("div",{className:"flex justify-between text-sm text-red-600",children:[e.jsx("span",{children:"خصم إضافي:"}),e.jsxs("span",{className:"font-semibold",children:["-",o.toFixed(2)," د.ع"]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsx("span",{children:"الربح المتوقع:"}),e.jsxs("span",{className:"font-semibold",children:[a.profit.toFixed(2)," د.ع"]})]}),e.jsxs("div",{className:"flex justify-between text-base font-bold border-t pt-1 mt-1",children:[e.jsx("span",{children:"الإجمالي:"}),e.jsxs("span",{className:"text-blue-600",children:[a.total.toFixed(2)," د.ع"]})]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200",children:[e.jsx("div",{className:"p-3 border-b border-gray-200",children:e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"معلومات العميل والدفع"})}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"العميل"}),e.jsxs("select",{value:m?.id||"",onChange:s=>{const t=j.find(d=>d.id==s.target.value);S(t)},className:`w-full px-2 py-1.5 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 ${r.customer?"border-red-500":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"اختر عميل"}),j.map(s=>e.jsxs("option",{value:s.id,children:[s.name," ",s.phone&&`- ${s.phone}`]},s.id))]}),r.customer&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:r.customer})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"المبلغ المدفوع"}),e.jsx("input",{type:"number",step:"0.01",value:x,onChange:s=>F(parseFloat(s.target.value)||0),className:`w-full px-2 py-1.5 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 ${r.paidAmount?"border-red-500":"border-gray-300"}`,placeholder:"0.00"}),r.paidAmount&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:r.paidAmount})]}),e.jsxs("div",{className:`flex justify-between text-sm p-2 rounded-lg ${a.remaining>0?"bg-red-50 text-red-700":"bg-green-50 text-green-700"}`,children:[e.jsx("span",{children:"المتبقي:"}),e.jsxs("span",{className:"font-semibold",children:[a.remaining.toFixed(2)," د.ع"]})]}),a.remaining>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"تاريخ الاستحقاق"}),e.jsx("input",{type:"date",value:p,onChange:s=>D(s.target.value),min:new Date().toISOString().split("T")[0],className:`w-full px-2 py-1.5 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 ${r.dueDate?"border-red-500":"border-gray-300"}`}),r.dueDate&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:r.dueDate})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"ملاحظات"}),e.jsx("textarea",{value:f,onChange:s=>k(s.target.value),rows:2,className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",placeholder:"ملاحظات إضافية..."})]}),e.jsxs("div",{className:"flex items-center gap-2 p-2 rounded-lg bg-gray-50",children:[u()==="paid"&&e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{className:"text-sm text-green-700 font-medium",children:"دفع كامل"})]}),u()==="partial"&&e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4 text-yellow-500"}),e.jsx("span",{className:"text-sm text-yellow-700 font-medium",children:"دفع جزئي"})]}),u()==="debt"&&e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:"text-sm text-red-700 font-medium",children:"دين كامل"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-3",children:[e.jsxs("button",{onClick:T,disabled:y||i.length===0,className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors text-sm",children:[y?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(L,{className:"w-4 h-4"}),"إنجاز البيع"]}),e.jsx("button",{onClick:v,className:"px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm",children:"إلغاء"})]}),Object.keys(r).length>0&&e.jsx("div",{className:"p-2 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("div",{className:"text-red-700 text-xs",children:Object.values(r).map((s,t)=>e.jsxs("div",{children:["• ",s]},t))})})]})]})]})]})]})};export{W as default};
